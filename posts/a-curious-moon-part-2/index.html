<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> A Curious Moon - Part 2 | Ash Midgley</title>
  <meta name="description" content="Full stack web developer based in Wellington, New Zealand.">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="A Curious Moon - Part 2" />
<meta property="og:description" content="More database stuff. Buckle up. Little hand says it&rsquo;s time to rock and roll.
Views A stored result set from a query that, once created, you can query just like a normal table. It is a virtual table that is populated dynamically when it is requested by a query.
 &ldquo;A view is just a projection of data from a source. Nothing is stored anywhere, and every time I query a view I’m actually querying the underlying tables through it." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ashmidgley.github.io/posts/a-curious-moon-part-2/" />
<meta property="article:published_time" content="2019-08-28T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-08-28T00:00:00+00:00" />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="A Curious Moon - Part 2"/>
<meta name="twitter:description" content="More database stuff. Buckle up. Little hand says it&rsquo;s time to rock and roll.
Views A stored result set from a query that, once created, you can query just like a normal table. It is a virtual table that is populated dynamically when it is requested by a query.
 &ldquo;A view is just a projection of data from a source. Nothing is stored anywhere, and every time I query a view I’m actually querying the underlying tables through it."/>

  
  
    
  
  
  <link rel="stylesheet" href="https://ashmidgley.github.io/css/style-classic.css">
  
  
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://ashmidgley.github.io/images/favicon.ico" />

  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

  <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
        <li><a href="/posts">All posts</a></li>
         
        <li><a href="/about">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li>
          <a class="icon" href=" https://ashmidgley.github.io/posts/a-curious-moon-part-1/">
            <i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i>
          </a>
        </li>
        
        
        <li>
          <a class="icon" href="https://ashmidgley.github.io/posts/csharp-in-depth/">
            <i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i>
          </a>
        </li>
        
        <li>
          <a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');">
            <i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i>
          </a>
        </li>
        <li>
          <a class="icon" href="#">
            <i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i>
          </a>
        </li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fashmidgley.github.io%2fposts%2fa-curious-moon-part-2%2f">
      <i class="fab fa-facebook " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fashmidgley.github.io%2fposts%2fa-curious-moon-part-2%2f&text=A%20Curious%20Moon%20-%20Part%202">
      <i class="fab fa-twitter " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fashmidgley.github.io%2fposts%2fa-curious-moon-part-2%2f&title=A%20Curious%20Moon%20-%20Part%202">
      <i class="fab fa-linkedin " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fashmidgley.github.io%2fposts%2fa-curious-moon-part-2%2f&is_video=false&description=A%20Curious%20Moon%20-%20Part%202">
      <i class="fab fa-pinterest " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=A%20Curious%20Moon%20-%20Part%202&body=Check out this article: https%3a%2f%2fashmidgley.github.io%2fposts%2fa-curious-moon-part-2%2f">
      <i class="fas fa-envelope " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fashmidgley.github.io%2fposts%2fa-curious-moon-part-2%2f&title=A%20Curious%20Moon%20-%20Part%202">
      <i class="fab fa-get-pocket " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fashmidgley.github.io%2fposts%2fa-curious-moon-part-2%2f&title=A%20Curious%20Moon%20-%20Part%202">
      <i class="fab fa-reddit " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2fashmidgley.github.io%2fposts%2fa-curious-moon-part-2%2f&title=A%20Curious%20Moon%20-%20Part%202">
      <i class="fab fa-stumbleupon " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://digg.com/submit?url=https%3a%2f%2fashmidgley.github.io%2fposts%2fa-curious-moon-part-2%2f&title=A%20Curious%20Moon%20-%20Part%202">
      <i class="fab fa-digg " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fashmidgley.github.io%2fposts%2fa-curious-moon-part-2%2f&name=A%20Curious%20Moon%20-%20Part%202&description=More%20database%20stuff.%20Buckle%20up.%20Little%20hand%20says%20it%26rsquo%3bs%20time%20to%20rock%20and%20roll.%0aViews%20A%20stored%20result%20set%20from%20a%20query%20that%2c%20once%20created%2c%20you%20can%20query%20just%20like%20a%20normal%20table.%20It%20is%20a%20virtual%20table%20that%20is%20populated%20dynamically%20when%20it%20is%20requested%20by%20a%20query.%0a%20%26ldquo%3bA%20view%20is%20just%20a%20projection%20of%20data%20from%20a%20source.%20Nothing%20is%20stored%20anywhere%2c%20and%20every%20time%20I%20query%20a%20view%20I%e2%80%99m%20actually%20querying%20the%20underlying%20tables%20through%20it.">
      <i class="fab fa-tumblr " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fashmidgley.github.io%2fposts%2fa-curious-moon-part-2%2f&t=A%20Curious%20Moon%20-%20Part%202">
      <i class="fab fa-hacker-news " aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>
    <div id="toc">
      <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
  </span>
</div>


  <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <header>
      <h1 class="posttitle" itemprop="name headline">
        A Curious Moon - Part 2
      </h1>
      <div class="meta">
        
        <div class="postdate">
          
          <time datetime="2019-08-28 00:00:00 &#43;0000 UTC" itemprop="datePublished">2019-08-28</time>
          
        </div>
        
        
      </div>
    </header>

  
    <div class="content" itemprop="articleBody">
      <p>More database stuff. Buckle up. Little hand says it&rsquo;s time to rock and roll.</p>
<p><img src="/assets/images/point-break-2.jpg" alt="Ex-president"></p>
<h4 id="views">Views</h4>
<p>A stored result set from a query that, once created, you can query just like a normal table. It is a virtual table that is populated dynamically when it is requested by a query.</p>
<blockquote>
<p>&ldquo;A view is just a projection of data from a source. Nothing is stored anywhere, and every time I query a view I’m actually querying the underlying tables through it.&rdquo;</p>
</blockquote>
<pre><code>create view example_view as
select
 ...
from example_table
</code></pre><h4 id="materialized-views">Materialized views</h4>
<p>Same as a view except rather than a virtual table we cache/materialize the resulting data from the query to disk.</p>
<pre><code>create materialized view example_view as
select
 ...
from example_table
</code></pre><h4 id="temp-tables">Temp tables</h4>
<p>Act the same as normal tables except they are deleted when the current client session terminates. Useful for keeping temporary data.</p>
<pre><code>create temp table example (
 ...
)
</code></pre><h4 id="junction-tables">Junction tables</h4>
<p>Used for tables with a many-to-many relationship. Sometimes called link or bridge tables.</p>
<p>Example: Student&rsquo;s and classrooms in a school.</p>
<p>In this scenario you cannot add foreign keys as a student has multiple classrooms aswell as a classroom having multiple students.</p>
<p>Creating a junction table for tables A and B:</p>
<ul>
<li>Create a table with 2 fields. The primary key of table A and the primary key of table B</li>
<li>Then add a primary key for the table which should combine the two foreign keys in order to ensure a unique value.</li>
</ul>
<pre><code>create table junction_table (
 table_a_id int not null unique references table_a(id),
 table_b_id int not null references table_b(id),
 primary key(table_a_id, table_b_id)
);
</code></pre><h4 id="ctes">CTE&rsquo;s</h4>
<p>Stands for Common Table Expressions. They allow you to chain queries and pass the values into the next query block. It&rsquo;s like functional SQL. Used across the board in different RDBMS&rsquo;s.</p>
<pre><code>with first as(
 select
  ...
 from example_table
), second as(
 select
  ...
 from first
)
select * from second;
</code></pre><h4 id="functions">Functions</h4>
<p>Like a fuction elsewhere in programming except it&rsquo;s applied to a database and is written in SQL.</p>
<pre><code>drop function if exists match_time (
 double precision,
 double precision
);

create function match_time (
 yr double precision,
 wk double precision,
 out timestamp
)
as $$
 select
  timestamp
 from example_a_table
 where year = yr and week = wk
$$ language sql;
</code></pre><p>Then when we want to call the function:</p>
<pre><code>select 
 match_time(year, week) as time_stamp,
from example_b_table
</code></pre><h4 id="aggregate-functions">Aggregate functions</h4>
<p>A type of function where values of multiple rows are grouped together to form a single value.</p>
<p>Common examples of grouping using aggregate functions:</p>
<ul>
<li>Average</li>
<li>Count</li>
<li>Min</li>
<li>Max</li>
<li>Median</li>
<li>Mode</li>
<li>Range</li>
<li>Sum</li>
</ul>
<pre><code>select 
 count(1) as count, 
 description
from events
group by description;
</code></pre><h4 id="window-functions">Window functions</h4>
<p>Work in the same fashion as aggregate function&rsquo;s but instead of reducing multiple rows into a single row, they keep all rows while still applying the grouping on the value you have specified.</p>
<pre><code>select 
 description,
 count(1) over (partition by description)
from events
</code></pre><p>In the above example the partition keyword is used and you would get multiple descriptions with the count rather than just a single description with the count like in an aggregate function.</p>
<p>Example output:</p>
<pre><code>description | count
-------------------
value1      | 3
value1      | 3
value1      | 3
value2      | 7
value2      | 7
value3      | 4
</code></pre><p>Aggregate function output:</p>
<pre><code>description | count
-------------------
value1      | 3
value2      | 7
value3      | 4
</code></pre><p>This example seems useless but there are cases where window functions are useful. To see a case of a window function being put to good use, refer to page 230 in the book.</p>
<h4 id="sargeable-vs-non-sargeable-queries">Sargeable vs. non-sargeable queries</h4>
<p>Sargeable:</p>
<ul>
<li>Search ARGumEnt ABLE</li>
<li>Query that can be optimized by using indexes for faster searches and execution.</li>
<li>Good -&gt; try to always use.</li>
</ul>
<blockquote>
<p>&ldquo;Sometimes you can’t get away from searching with a fuzzy string parameter, which is OK. This is a database after all. The trick is to be sure that you’re using some kind of optimization. Otherwise, Postgres has a lot of work to do.&rdquo;</p>
</blockquote>
<p>Non-sargeable:</p>
<ul>
<li>Query that can&rsquo;t be optimized.</li>
<li>To find the rows your looking for, postgres has to search every row in the table (sequential scan).</li>
<li>AVOID.</li>
</ul>
<blockquote>
<p>&ldquo;It&rsquo;s not a big deal if the database is small, but as it grows the search will begin to slow down. Over time, maybe days, maybe years, the table will grow to the point that searches are too slow to run.&rdquo;</p>
</blockquote>
<h4 id="full-text-indexing">Full-text indexing</h4>
<p>Indexing a body of text for faster querying.</p>
<blockquote>
<p>&ldquo;You basically tweak a body of text and index it, prioritizing useful terms and deprioritizing &lsquo;noise.&rsquo; If you do it right, you can make finding things a lot easier for Postgres. This is how Google makes money.&rdquo;</p>
</blockquote>
<pre><code>create view example_view as
select
 description
 to_tsvector(description) as search
from example_table
</code></pre><p>Then when you are searching the view:</p>
<pre><code>select 
 id, date, title
from example_view
where search @@ to_tsquery('testing');
</code></pre><p>@@ = output matches. Other search symbols <a href="https://www.postgresql.org/docs/current/functions-textsearch.html">here</a>. More usages of to_tsvector <a href="https://www.postgresql.org/docs/current/textsearch-controls.html">here</a>.</p>
<h4 id="ranges">Ranges</h4>
<p>Postgres allows datatypes that are ranges. There are numeric and date/time ranges.</p>
<pre><code>alter table example_table
add range_test tsrange;

update example_table
set range_test = tsrange(start, end, '[]');
</code></pre><blockquote>
<p>&ldquo;The [] option tells Postgres that this range is inclusive, meaning the upper and lower bounds of the range should be included. If I had used () as an option the range would be exclusive, meaning all dates between the upper and lower bound are considered the value. You can combine these two symbols as well. For instance, this: [) is a range that is inclusive on the lower bound, exclusive on the upper.&rdquo;</p>
</blockquote>
<p>Querying a range:</p>
<pre><code>select 
 description 
from example_table
where range_test @&gt; '2019-01-15'::timestamp;
</code></pre><h4 id="analyzing-query-execution">Analyzing query execution</h4>
<p>When tossing up between queries you can use the <code>explain</code> keyword (before your query) and postgres will give you a break down of what happens on execution.</p>
<p>Cost:</p>
<ul>
<li>Relative measurement of time it takes to read data from disk.</li>
<li>Lower = better.</li>
</ul>
<p>Rows:</p>
<ul>
<li>Estimated number of rows output from the query.</li>
</ul>
<pre><code>explain update example_table
set example_id = (
    select id from another_table
    where date = example_table.time_stamp::date
    limit 1
);
</code></pre><p>You can also use <code>explain analyze</code> and this will run the query and tell you what happened.</p>
<h4 id="end">End</h4>
<p>Sheesh, my head hurts. Congrats on making it this far. If you&rsquo;re interested in learning more, grab a copy of the book at <a href="https://bigmachine.io/products/a-curious-moon">Big Machine</a> or check out the database related posts on <a href="https://rob.conery.io/categories#Database">Rob&rsquo;s blog</a>.</p>

    </div>
  </article>

  
  





  <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/posts">All posts</a></li>
         
          <li><a href="/about">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>

    <div id="share-footer" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fashmidgley.github.io%2fposts%2fa-curious-moon-part-2%2f">
      <i class="fab fa-facebook fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fashmidgley.github.io%2fposts%2fa-curious-moon-part-2%2f&text=A%20Curious%20Moon%20-%20Part%202">
      <i class="fab fa-twitter fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fashmidgley.github.io%2fposts%2fa-curious-moon-part-2%2f&title=A%20Curious%20Moon%20-%20Part%202">
      <i class="fab fa-linkedin fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fashmidgley.github.io%2fposts%2fa-curious-moon-part-2%2f&is_video=false&description=A%20Curious%20Moon%20-%20Part%202">
      <i class="fab fa-pinterest fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=A%20Curious%20Moon%20-%20Part%202&body=Check out this article: https%3a%2f%2fashmidgley.github.io%2fposts%2fa-curious-moon-part-2%2f">
      <i class="fas fa-envelope fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fashmidgley.github.io%2fposts%2fa-curious-moon-part-2%2f&title=A%20Curious%20Moon%20-%20Part%202">
      <i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fashmidgley.github.io%2fposts%2fa-curious-moon-part-2%2f&title=A%20Curious%20Moon%20-%20Part%202">
      <i class="fab fa-reddit fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2fashmidgley.github.io%2fposts%2fa-curious-moon-part-2%2f&title=A%20Curious%20Moon%20-%20Part%202">
      <i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://digg.com/submit?url=https%3a%2f%2fashmidgley.github.io%2fposts%2fa-curious-moon-part-2%2f&title=A%20Curious%20Moon%20-%20Part%202">
      <i class="fab fa-digg fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fashmidgley.github.io%2fposts%2fa-curious-moon-part-2%2f&name=A%20Curious%20Moon%20-%20Part%202&description=More%20database%20stuff.%20Buckle%20up.%20Little%20hand%20says%20it%26rsquo%3bs%20time%20to%20rock%20and%20roll.%0aViews%20A%20stored%20result%20set%20from%20a%20query%20that%2c%20once%20created%2c%20you%20can%20query%20just%20like%20a%20normal%20table.%20It%20is%20a%20virtual%20table%20that%20is%20populated%20dynamically%20when%20it%20is%20requested%20by%20a%20query.%0a%20%26ldquo%3bA%20view%20is%20just%20a%20projection%20of%20data%20from%20a%20source.%20Nothing%20is%20stored%20anywhere%2c%20and%20every%20time%20I%20query%20a%20view%20I%e2%80%99m%20actually%20querying%20the%20underlying%20tables%20through%20it.">
      <i class="fab fa-tumblr fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fashmidgley.github.io%2fposts%2fa-curious-moon-part-2%2f&t=A%20Curious%20Moon%20-%20Part%202">
      <i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>

    <div id="actions-footer">
      
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;">
          <i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;">
          <i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;">
          <i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');">
          <i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>


  <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2020  Ash Midgley 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/posts">All posts</a></li>
         
        <li><a href="/about">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>



</html>
